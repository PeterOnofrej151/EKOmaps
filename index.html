<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EKO-doprava v PSK - Mapa Lokal칤t</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

  <style>
    /* CSS Variabilita - Modern치 Paleta */
    :root {
      --primary-color: #4285F4; /* Google Blue */
      --primary-dark-color: #0056b3; /* Tmav코칤 odtie켿 modrej */
      --accent-color: #34A853; /* Google Green pre 칰spech */
      --danger-color: #EA4335; /* Google Red pre nebezpe캜n칠 akcie */
      --warning-color: #FBBC04; /* Google Yellow pre varovanie */
      --background-light: #F8F9FA; /* Ve쬸i svetl칠 pozadie */
      --surface-light: #FFFFFF;   /* Biela pre karty/panely */
      --text-color: #3C4043;      /* Tmav칳 text */
      --light-text-color: #70757A; /* Svetlej코칤 text */
      --border-color: #DADCE0;     /* Jemn칠 or치movanie */
      --shadow-color: rgba(0, 0, 0, 0.08); /* Jemn칳 tie켿 */
      --border-radius: 8px; /* Zaoblenie rohov */
    }

    html, body {
      height: 100%;
      margin: 0;
      font-family: 'Inter', sans-serif; /* Nov칳 font */
      color: var(--text-color);
      background-color: var(--background-light);
      overflow: hidden; /* Zamedzi콘 scrollovaniu celej str치nky */
    }

    #obsah {
      display: flex;
      height: 100%;
      transition: all 0.3s ease;
    }

    #obsah.fullscreen #mapa { width: 100%; }

    #mapa {
      flex-grow: 1; /* Mapa zaber치 zvy코ok miesta */
      height: 100%;
      position: relative;
      background-color: #e0e0e0; /* Fallback pre mapu */
    }

    #sidebar {
      width: 380px; /* Pevn치 코칤rka sidebaru pre lep코칤 vizu치l */
      max-width: 90%; /* Pre mal칠 obrazovky */
      padding: 20px;
      background: var(--surface-light);
      overflow-y: auto;
      position: relative;
      transition: width 0.3s ease, padding 0.3s ease, transform 0.3s ease;
      box-shadow: -4px 0 15px var(--shadow-color); /* Tie켿 na쬬vo */
      z-index: 1000; /* Zabezpe캜i콘, aby bol nad mapou */
      border-left: 1px solid var(--border-color); /* Jemn치 deliaca 캜iara */
    }
    #sidebar.collapsed {
      width: 0;
      padding: 0;
      overflow: hidden;
      transform: translateX(100%); /* Posunie mimo obrazovku doprava */
    }

    #sidebar-logo {
        display: block;
        max-width: 80%; /* Prisp칪sobi콘 코칤rku */
        height: auto;
        margin: 0 auto 25px auto; /* Centrova콘 a prida콘 spodn칳 okraj */
        filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
    }


    /* Vylep코en칳 코t칳l pre polo쬶y v zozname lokal칤t */
    .lokalita {
      background-color: var(--surface-light);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      margin-bottom: 12px;
      padding: 12px 15px;
      box-shadow: 0 2px 5px var(--shadow-color);
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: flex-start; /* Zarovnanie na za캜iatok pre pr칤pad dlh코ieho textu */
      transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }
    .lokalita:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.12);
    }
    .lokalita-info {
      flex-grow: 1;
      margin-right: 10px;
      font-size: 0.95em;
    }
    .lokalita-info strong {
      font-weight: 600;
      color: var(--primary-color);
      display: block;
      margin-bottom: 3px;
    }
    .lokalita-info small {
      color: var(--light-text-color);
      font-size: 0.85em;
    }
    .lokalita-actions {
      display: flex;
      gap: 8px; /* Medzera medzi tla캜idlami */
    }
    .lokalita-actions button {
      padding: 6px 10px;
      font-size: 13px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      transition: background-color 0.2s ease, box-shadow 0.2s ease;
    }
    .lokalita-actions .edit-btn { background-color: var(--primary-color); color: white; }
    .lokalita-actions .edit-btn:hover { background-color: var(--primary-dark-color); box-shadow: 0 2px 5px rgba(0,0,0,0.15); }
    .lokalita-actions .delete-btn { background-color: var(--danger-color); color: white; }
    .lokalita-actions .delete-btn:hover { background-color: #C62828; box-shadow: 0 2px 5px rgba(0,0,0,0.15); }

    /* V코eobecn칳 코t칳l pre tla캜idl치 */
    .btn {
      background-color: var(--primary-color);
      color: white;
      padding: 10px 18px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 500;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 2px 5px var(--shadow-color);
      margin-right: 10px;
      margin-bottom: 10px;
    }
    .btn:hover {
      background-color: var(--primary-dark-color);
      transform: translateY(-1px);
      box-shadow: 0 3px 8px rgba(0,0,0,0.12);
    }
    .btn:active {
      transform: translateY(0);
      box-shadow: 0 1px 3px rgba(0,0,0,0.15);
    }

    /* 맗ecifick칠 코t칳ly pre tla캜idl치 */
    #printListBtn { background-color: var(--accent-color); }
    #printListBtn:hover { background-color: #2E8B57; }
    #exportBtn { background-color: #6C757D; } /* Sekund치rna 코ed치 */
    #exportBtn:hover { background-color: #5A6268; }
    #saveBtn { background-color: #17A2B8; } /* Info modr치 */
    #saveBtn:hover { background-color: #138496; }
    #clearDataBtn { background-color: var(--danger-color); }
    #clearDataBtn:hover { background-color: #C62828; }
    #showAddModalBtn { background-color: var(--accent-color); }
    #showAddModalBtn:hover { background-color: #2E8B57; }
    /* NOVINKA: 맚칳l pre tla캜idlo v re쬴me zru코enia */
    #showAddModalBtn.cancel-mode {
        background-color: var(--warning-color);
    }
    #showAddModalBtn.cancel-mode:hover {
        background-color: #d4a103;
    }

    /* NOVINKA: 맚칳l pre textov칳 pokyn */
    #add-mode-guide {
        display: none; /* 맚andardne skryt칠 */
        padding: 10px;
        background-color: #e9f2ff;
        border: 1px solid var(--primary-color);
        border-radius: var(--border-radius);
        margin-top: 10px;
        font-size: 0.9em;
        color: var(--primary-dark-color);
        text-align: center;
    }

    #logo {
      position: absolute; bottom: 22px; right: 15px;
      width: 160px; z-index: 1000;
      filter: drop_shadow(0 2px 4px rgba(0,0,0,0.1));
    }
    #toggleSidebar {
      position: absolute; top: 20px; right: 20px;
      width: 40px; height: 40px;
      background: var(--surface-light);
      border: none;
      border-radius: 50%;
      box-shadow: 0 2px 5px var(--shadow-color);
      cursor: pointer;
      display: flex; align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 20px;
      color: var(--primary-color);
      z-index: 1001;
      transition: transform 0.3s ease, background-color 0.2s ease, box-shadow 0.2s ease;
    }
    #toggleSidebar:hover {
        background-color: #E6EAF0;
        box-shadow: 0 4px 8px rgba(0,0,0,0.12);
    }
    #toggleSidebar.collapsed {
        right: 20px; /* Zostane vpravo, ke캞 je sidebar skryt칳 */
        color: var(--light-text-color); /* In치 farba, ke캞 je skryt칳 */
    }

    #footerWatermark {
      position: absolute; bottom: 10px; left: 10px;
      font-size: 11px; color: #000; opacity: 0.4;
      z-index: 500; pointer-events: none;
      font-weight: 500;
    }

    #map-bottom-right-logo {
        position: absolute;
        bottom: 15px;
        left: 50%; /* Centrova콘 horizont치lne */
        transform: translateX(-50%); /* Presne centrova콘 */
        width: 100px;
        height: auto;
        z-index: 1000;
        filter: drop_shadow(0 2px 4px rgba(0,0,0,0.1));
    }

    /* 맚칳l pre inputy a selecty */
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text-color);
      font-size: 0.95em;
    }

    input[type="text"],
    input[type="number"],
    input[type="file"],
    select {
      width: calc(100% - 20px);
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid var(--border-color);
      border-radius: 5px;
      box-sizing: border-box;
      font-size: 1em;
      color: var(--text-color);
      background-color: var(--surface-light);
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    input[type="text"]:focus,
    input[type="number"]:focus,
    select:focus {
      border-color: var(--primary-color);
      outline: none;
      box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.2);
    }
    input:invalid {
        border-color: var(--danger-color);
        box-shadow: 0 0 0 2px rgba(234, 67, 53, 0.2);
    }

    input[type="file"] {
      padding: 8px;
    }
    input[type="file"]::-webkit-file-upload-button {
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 4px;
      padding: 8px 12px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    input[type="file"]::-webkit-file-upload-button:hover {
      background-color: var(--primary-dark-color);
    }

    /* Loading Spinner */
    #loadingSpinner {
      display: none;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      border: 6px solid #f3f3f3;
      border-top: 6px solid var(--primary-color);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      z-index: 1002;
    }

    @keyframes spin {
      0% { transform: translate(-50%, -50%) rotate(0deg); }
      100% { transform: translate(-50%, -50%) rotate(360deg); }
    }


    /* Modal pre edit치ciu a pridanie */
    .modal {
      display: none;
      position: fixed;
      z-index: 1003;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.6);
      backdrop-filter: blur(3px);
    }
    .modal-content {
      background-color: var(--surface-light);
      margin: 5% auto;
      padding: 30px;
      border: none;
      width: 90%;
      max-width: 650px;
      border-radius: var(--border-radius);
      position: relative;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    .close-button {
      color: var(--light-text-color);
      position: absolute;
      top: 15px;
      right: 20px;
      font-size: 30px;
      font-weight: normal;
      cursor: pointer;
      transition: color 0.2s ease;
    }
    .close-button:hover,
    .close-button:focus {
      color: var(--text-color);
    }
    .modal-content h2 {
      margin-top: 0;
      margin-bottom: 25px;
      color: var(--primary-color);
      font-weight: 600;
      font-size: 1.8em;
    }
    .modal-content label { margin-bottom: 8px; font-weight: 500; font-size: 0.9em;}
    .modal-content input[type="text"],
    .modal-content input[type="number"],
    .modal-content select {
      margin-bottom: 15px;
    }
    .modal-content button[type="submit"] {
      background-color: var(--primary-color);
      color: white;
      padding: 12px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1em;
      font-weight: 500;
      transition: background-color 0.2s ease;
    }
    .modal-content button[type="submit"]:hover {
      background-color: var(--primary-dark-color);
    }
    /* NOVINKA: Indik치tor na캜칤tavania adresy */
    #address-loader {
        display: none;
        font-style: italic;
        color: var(--light-text-color);
        margin-bottom: 15px;
    }

    /* 칔vodn칠 okno - Welcome Modal */
    #welcomeModal .modal-content {
        text-align: center;
        max-width: 500px;
        padding: 40px 30px;
    }
    #welcomeModal img {
        max-width: 70%;
        height: auto;
        margin-bottom: 25px;
        filter: drop-shadow(0 4px 8px rgba(0,0,0,0.15));
    }
    #welcomeModal h2 {
        color: var(--primary-color);
        margin-bottom: 15px;
        font-size: 2em;
    }
    #welcomeModal p {
        color: var(--text-color);
        line-height: 1.6;
        font-size: 1.1em;
        margin-bottom: 25px;
    }
    #welcomeModal button {
        background-color: var(--primary-color);
        color: white;
        padding: 12px 25px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1.1em;
        font-weight: 600;
        transition: background-color 0.2s ease, transform 0.1s ease;
    }
    #welcomeModal button:hover {
        background-color: var(--primary-dark-color);
        transform: translateY(-1px);
    }

    /* Sekcie v sidebare */
    .sidebar-section {
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border-color);
    }
    .sidebar-section:last-child {
      border-bottom: none;
      padding-bottom: 0;
      margin-bottom: 0;
    }
    .sidebar-section h3 {
        margin-top: 0;
        margin-bottom: 15px;
        color: var(--primary-color);
        font-size: 1.2em;
        font-weight: 600;
    }
    .no-results-message {
        padding: 15px;
        text-align: center;
        color: var(--light-text-color);
        font-style: italic;
        background-color: var(--background-light);
        border-radius: var(--border-radius);
        margin-top: 10px;
    }

    /* Basemap Switcher Styles */
    #basemap-switcher {
      position: absolute;
      top: 10px;
      left: 50px;
      background: var(--surface-light);
      padding: 10px;
      border-radius: var(--border-radius);
      box-shadow: 0 2px 5px var(--shadow-color);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 8px;
      width: 160px;
      pointer-events: auto;
    }
    .basemap-switcher-header {
        font-weight: 600;
        color: var(--primary-color);
        margin-bottom: 5px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-right: 5px;
        font-size: 0.95em;
    }
    .basemap-switcher-header i { transition: transform 0.2s ease; }
    .basemap-switcher-header i.rotated { transform: rotate(90deg); }
    .basemap-options {
        display: flex;
        flex-direction: column;
        gap: 8px;
        transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
        overflow: hidden;
        max-height: 200px;
    }
    .basemap-options.hidden {
        max-height: 0;
        opacity: 0;
        padding-top: 0;
        padding-bottom: 0;
    }
    #basemap-switcher label {
      display: flex;
      align-items: center;
      gap: 5px;
      cursor: pointer;
      font-size: 0.9em;
      font-weight: 400;
      color: var(--text-color);
      margin-bottom: 0;
    }
    #basemap-switcher input[type="radio"] {
      -webkit-appearance: none; -moz-appearance: none; appearance: none;
      width: 16px; height: 16px;
      border: 2px solid var(--primary-color);
      border-radius: 50%;
      outline: none;
      cursor: pointer;
      position: relative;
      flex-shrink: 0;
      margin-bottom: 0;
    }
    #basemap-switcher input[type="radio"]:checked {
      background-color: var(--primary-color);
      border-color: var(--primary-color);
    }
    #basemap-switcher input[type="radio"]:checked::before {
      content: ''; display: block;
      width: 8px; height: 8px;
      background-color: white;
      border-radius: 50%;
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
    }

    /* Print styles */
    @media print {
        @page { size: A4 landscape; margin: 10mm; }
        body {
            font-family: 'Inter', sans-serif;
            padding: 10px;
            font-size: 10px;
            color: black;
        }
        header { display: flex; align-items: center; margin-bottom: 20px; }
        header img { height: 50px; margin-right: 15px; }
        h2 { margin: 0; color: black; }
        table { border-collapse: collapse; width: auto; max-width: 100%; }
        th, td { border: 1px solid #555; padding: 6px 8px; text-align: left; white-space: nowrap; }
        th { background-color: #f0f0f0; }
    }
    /* --- 맚칳ly pre mobiln칠 zariadenia (obrazovky so 코칤rkou do 768px) --- */
@media (max-width: 768px) {
  #obsah {
    /* Zmen칤 usporiadanie z "ved쬬 seba" na "pod sebou" */
    flex-direction: column;
  }

  #sidebar {
    width: 100%; /* Sidebar zaberie pln칰 코칤rku */
    height: 50vh; /* V칳코ka sidebaru bude polovica obrazovky */
    max-width: 100%;
    border-left: none; /* Odstr치ni 캜iaru, ktor치 u nie je potrebn치 */
    box-shadow: 0 -4px 15px var(--shadow-color); /* Tie켿 bude hore */
    order: 2; /* Zmen칤 poradie, sidebar bude druh칳 (pod mapou) */
  }

  #mapa {
    height: 50vh; /* Mapa zaberie polovicu obrazovky */
    order: 1; /* Mapa bude prv치 (hore) */
  }

  /* 칔prava tla캜idla na skrytie/zobrazenie panelu pre mobiln칠 rozlo쬰nie */
  #toggleSidebar {
    /* Umiestnenie nad mapu, vpravo dole */
    top: auto;
    bottom: calc(50% + 10px); /* K칰sok nad stredov칰 캜iaru */
    right: 15px;
    z-index: 1001; /* Zabezpe캜칤, 쬰 je nad mapou */
  }

  #sidebar.collapsed {
    /* Pri skryt칤 sa panel "stiahne" pod obrazovku */
    transform: translateY(100%);
    height: 0;
    padding: 0;
    overflow: hidden;
  }
  
  /* Uprav칤me logo a vodoznaky, aby nezavadzali */
  #logo {
      width: 120px;
      bottom: calc(50% + 10px);
  }
  #map-bottom-right-logo {
      display: none; /* Skryjeme logo PSK, je u v sidebare */
  }
  #footerWatermark {
      bottom: calc(50% + 5px);
  }
}
  </style>
</head>
<body>

<div id="obsah">
  <div id="mapa">
    <a href="https://smartp.sk/" target="_blank" rel="noopener noreferrer">
        <img src="https://smartp.sk/images/logo.png" id="logo" alt="Logo Smart Regi칩nu" />
    </a>
    <div id="footerWatermark">춸 2025 Energetick치 Agent칰ra <a href="https://smartp.sk/" target="_blank" rel="noopener noreferrer" style="color: inherit; text-decoration: none; pointer-events: auto;">Smart Regi칩nu</a> <a href="https://psk.sk/" target="_blank" rel="noopener noreferrer" style="color: inherit; text-decoration: none; pointer-events: auto;">PSK</a>| v.1.25</div>
    <img src="https://i.imgur.com/Z5MrxCw.jpeg" id="map-bottom-right-logo" alt="Nov칠 logo PSK" />
    <div id="loadingSpinner"></div>

    <div id="basemap-switcher" class="leaflet-control">
        <div class="basemap-switcher-header">
            <span><i class="fas fa-layer-group" style="margin-right: 5px;"></i> Zakladn치 mapa</span>
            <i class="fas fa-chevron-right"></i>
        </div>
        <div class="basemap-options hidden">
            <label><input type="radio" name="basemap" value="osm" checked> OpenStreetMap</label>
            <label><input type="radio" name="basemap" value="google-streets"> Google Streets</label>
            <label><input type="radio" name="basemap" value="google-satellite"> Google Satellite</label>
            <label><input type="radio" name="basemap" value="google-hybrid"> Google Hybrid</label>
        </div>
    </div>
  </div>

  <div id="sidebar" role="complementary" aria-label="Bo캜n칳 panel s ovl치dan칤m">
    <a href="https://psk.sk/" target="_blank" rel="noopener noreferrer">
        <img src="https://i.imgur.com/VO7B8Gw.png" id="sidebar-logo" alt="EKO-doprava v PSK" />
    </a>

    <div class="sidebar-section">
      <h3>Spr치va lokal칤t</h3>
      <button id="showAddModalBtn" class="btn" aria-haspopup="dialog" aria-controls="addModal"><i class="fas fa-plus-circle"></i> Prida콘 nov칰 lokalitu</button>
      <div id="add-mode-guide">
          <i class="fas fa-mouse-pointer"></i> Teraz kliknite na mapu pre v칳ber polohy...
      </div>
    </div>

    <div class="sidebar-section">
      <h3>Filtre a Zoznam</h3>
      <label for="filter">游댌 Filtrova콘 pod쬬 typu:</label>
      <select id="filter">
        <option value="">V코etky</option>
        <option value="AC">AC</option>
        <option value="DC">DC</option>
        <option value="AC+DC">AC+DC</option>
      </select>
      <label for="searchFilter">游댍 H쬬da콘 lokalitu:</label>
      <input type="text" id="searchFilter" placeholder="N치zov, adresa, mesto..." aria-label="Vyh쬬d치vac칤 text pre lokality" /><br />

      <div id="zoznamLokalit"></div>
    </div>

    <div class="sidebar-section">
        <button id="printListBtn" class="btn"><i class="fas fa-print"></i> Tla캜i콘 zoznam</button>
    </div>

    <div class="sidebar-section" style="border-bottom: none; padding-bottom: 0;">
      <h3>D치tov칠 oper치cie</h3>
      <label for="fileInput">游닌 Importova콘 z Excelu:</label>
      <input type="file" id="fileInput" accept=".xlsx" aria-label="Vyberte s칰bor Excelu pre import" /><br />

      <label for="jsonInput">鮫勇 Obnovi콘 zo z치lohy (.json):</label>
      <input type="file" id="jsonInput" accept=".json" aria-label="Vyberte s칰bor JSON pre obnovu zo z치lohy" /><br />

      <div style="font-size: 0.85em; color: var(--light-text-color); margin-bottom: 15px;">
        游닇 <strong>Excel s칰bor mus칤 obsahova콘 st컄pce:</strong><br />
        <code style="font-size: 0.9em;">name, lat, lng, polis, vykon, konektory, typ, adresa, prevadzkovatel, id_bodu, autentifikacia, platba, kontakt, prevadzka, datum</code>
      </div>

      <button id="exportBtn" class="btn"><i class="fas fa-file-excel"></i> Export do Excelu</button>
      <button onclick="ulozLokality()" class="btn" id="saveBtn"><i class="fas fa-save"></i> Zalohova콘 (.json)</button>
      <button onclick="clearAllData()" class="btn" id="clearDataBtn"><i class="fas fa-trash-alt"></i> Vymaza콘 ulo쬰n칠 d치ta</button>
    </div>

  </div>
</div>

<button id="toggleSidebar" title="Skry콘 panel" aria-controls="sidebar" aria-expanded="true">
    <i class="fas fa-chevron-right"></i>
</button>

<div id="editModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="editModalTitle">
  <div class="modal-content">
    <span class="close-button" id="closeEditModal" role="button" tabindex="0" aria-label="Zatvori콘">&times;</span>
    <h2 id="editModalTitle">Upravi콘 lokalitu</h2>
    <form id="editForm">
      <input type="hidden" id="editIndex" />
      <input type="hidden" id="editId" />
      <label for="editName">N치zov:</label>
      <input type="text" id="editName" required /><br />
      <label for="editLat">Zemepisn치 코칤rka:</label>
      <input type="number" id="editLat" step="any" required min="-90" max="90" /><br />
      <label for="editLng">Zemepisn치 d컄쬶a:</label>
      <input type="number" id="editLng" step="any" required min="-180" max="180" /><br />
      <label for="editPolis">Mesto:</label>
      <input type="text" id="editPolis" /><br />
      <label for="editVykon">V칳kon (kW):</label>
      <input type="number" id="editVykon" step="any" min="0"/><br />
      <label for="editKonektory">Konektory:</label>
      <input type="text" id="editKonektory" /><br />
      <label for="editTyp">Typ:</label>
      <select id="editTyp">
        <option value="AC">AC</option>
        <option value="DC">DC</option>
        <option value="AC+DC">AC+DC</option>
      </select><br />
      <label for="editAdresa">Adresa:</label>
      <input type="text" id="editAdresa" /><br />
      <label for="editPrevadzkovatel">Prev치dzkovate:</label>
      <input type="text" id="editPrevadzkovatel" /><br />
      <label for="editIdBodu">ID bodu:</label>
      <input type="text" id="editIdBodu" /><br />
      <label for="editAutentifikacia">Autentifik치cia:</label>
      <input type="text" id="editAutentifikacia" /><br />
      <label for="editPlatba">Platba:</label>
      <input type="text" id="editPlatba" /><br />
      <label for="editKontakt">Kontakt:</label>
      <input type="text" id="editKontakt" /><br />
      <label for="editPrevadzka">Doba prev치dzky:</label>
      <input type="text" id="editPrevadzka" placeholder="Napr. 24/7" /><br />
      <label for="editDatum">Uveden칠 do prev치dzky:</label>
      <input type="text" id="editDatum" placeholder="YYYY-MM-DD" pattern="\d{4}-\d{2}-\d{2}" /><br />
      <button type="submit">Ulo쬴콘 zmeny</button>
    </form>
  </div>
</div>

<div id="addModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="addModalTitle">
  <div class="modal-content">
    <span class="close-button" id="closeAddModal" role="button" tabindex="0" aria-label="Zatvori콘">&times;</span>
    <h2 id="addModalTitle">Prida콘 nov칰 lokalitu</h2>
    <form id="addForm">
      <label for="addName">N치zov:</label>
      <input type="text" id="addName" required /><br />
      <label for="addLat">Zemepisn치 코칤rka:</label>
      <input type="number" id="addLat" step="any" required min="-90" max="90" /><br />
      <label for="addLng">Zemepisn치 d컄쬶a:</label>
      <input type="number" id="addLng" step="any" required min="-180" max="180" /><br />
      <div id="address-loader"><i class="fas fa-spinner fa-spin"></i> Na캜칤tavam adresu...</div>
      <label for="addPolis">Mesto:</label>
      <input type="text" id="addPolis" /><br />
      <label for="addAdresa">Adresa:</label>
      <input type="text" id="addAdresa" /><br />
      <label for="addVykon">V칳kon (kW):</label>
      <input type="number" id="addVykon" step="any" min="0" /><br />
      <label for="addKonektory">Konektory:</label>
      <input type="text" id="addKonektory" /><br />
      <label for="addTyp">Typ:</label>
      <select id="addTyp">
        <option value="AC">AC</option>
        <option value="DC">DC</option>
        <option value="AC+DC">AC+DC</option>
      </select><br />
      <label for="addPrevadzkovatel">Prev치dzkovate:</label>
      <input type="text" id="addPrevadzkovatel" /><br />
      <label for="addIdBodu">ID bodu:</label>
      <input type="text" id="addIdBodu" /><br />
      <label for="addAutentifikacia">Autentifik치cia:</label>
      <input type="text" id="addAutentifikacia" /><br />
      <label for="addPlatba">Platba:</label>
      <input type="text" id="addPlatba" /><br />
      <label for="addKontakt">Kontakt:</label>
      <input type="text" id="addKontakt" /><br />
      <label for="addPrevadzka">Doba prev치dzky:</label>
      <input type="text" id="addPrevadzka" placeholder="Napr. 24/7" /><br />
      <label for="addDatum">Uveden칠 do prev치dzky:</label>
      <input type="text" id="addDatum" placeholder="YYYY-MM-DD" pattern="\d{4}-\d{2}-\d{2}" /><br />
      <button type="submit">Prida콘 lokalitu</button>
    </form>
  </div>
</div>

<div id="welcomeModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="welcomeModalTitle">
  <div class="modal-content">
    <img src="https://i.imgur.com/VO7B8Gw.png" alt="Logo EKO-doprava v PSK" style="max-width: 250px; margin-bottom: 20px;" />
    <h2 id="welcomeModalTitle">Vitajte na interakt칤vnej mape EKO-dopravy v PSK!</h2>
    <p>
      T치to aplik치cia, vyvinut치 v spolupr치ci s Energetickou agent칰rou Smart Regi칩nu PSK, umo쮄갓je vizualiz치ciu a spr치vu nab칤jac칤ch bodov pre elektromobily v r치mci projektu EKO-doprava v PSK.
    </p>
    <p>
      M칪쬰te si prezera콘 existuj칰ce nab칤jacie stanice, filtrova콘 ich pod쬬 typu, h쬬da콘 konkr칠tne lokality a dokonca prid치va콘, upravova콘 alebo maza콘 칰daje o nab칤jac칤ch bodoch. V코etky d치ta je mo쬹칠 exportova콘 do Excelu.
<p class="app-version">Verzia aplik치cie: 1.25</p>
    </p>
    <button id="closeWelcomeModal">Rozumiem a za캜a콘</button>
  </div>
</div>


<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/read-excel-file@5.8.8/bundle/read-excel-file.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

<script>
  const mapa = L.map('mapa').setView([49.0, 21.24], 8);

  // Basemap Layers
  const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '춸 OpenStreetMap contributors'
  });
  const googleStreets = L.tileLayer('http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}',{
    maxZoom: 20,
    subdomains:['mt0','mt1','mt2','mt3'],
    attribution: 'Google'
  });
  const googleSat = L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',{
    maxZoom: 20,
    subdomains:['mt0','mt1','mt2','mt3'],
    attribution: 'Google'
  });
  const googleHybrid = L.tileLayer('http://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}',{
    maxZoom: 20,
    subdomains:['mt0','mt1','mt2','mt3'],
    attribution: 'Google'
  });
  let currentBasemap = osmLayer.addTo(mapa);

  const defaultMapView = { center: [49.0, 21.24], zoom: 8 };

  const markerIcons = {
    'AC': L.icon({ iconUrl: 'https://i.imgur.com/v0b5Mpo.png', iconSize: [50, 50], iconAnchor: [18, 50], popupAnchor: [0, -36] }),
    'DC': L.icon({ iconUrl: 'https://i.imgur.com/BxTzF0C.png', iconSize: [50, 50], iconAnchor: [18, 50], popupAnchor: [0, -36] }),
    'AC+DC': L.icon({ iconUrl: 'https://i.imgur.com/BxTzF0C.png', iconSize: [50, 50], iconAnchor: [18, 50], popupAnchor: [0, -36] }),
    'default': L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/4430/4430939.png', iconSize: [50, 50], iconAnchor: [18, 50], popupAnchor: [0, -36] }),
    'temp': L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-grey.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png', shadowSize: [41, 41] })
  };

  let lokality = [];
  const markers = [];
  const loadingSpinner = document.getElementById('loadingSpinner');
  
  let isAddingLocationMode = false;
  let tempMarker = null;

  const requiredColumns = {
      name: 'string', lat: 'number', lng: 'number', polis: 'string',
      vykon: 'number', konektory: 'string', typ: 'string', adresa: 'string',
      prevadzkovatel: 'string', id_bodu: 'string', autentifikacia: 'string',
      platba: 'string', kontakt: 'string', prevadzka: 'string', datum: 'string'
  };

  // Debounce funkcia
  function debounce(func, delay) {
    let timeout;
    return function(...args) {
      clearTimeout(timeout);
      timeout = setTimeout(() => func.apply(this, args), delay);
    };
  }

  // Toastify Notifik치cie s ikonami
  function showToast(message, type = 'info', duration = 3500) {
    let backgroundColor;
    let iconClass;
    switch(type) {
      case 'success': backgroundColor = 'var(--accent-color)'; iconClass = 'fas fa-check-circle'; break;
      case 'error': backgroundColor = 'var(--danger-color)'; iconClass = 'fas fa-times-circle'; break;
      case 'warning': backgroundColor = 'var(--warning-color)'; iconClass = 'fas fa-exclamation-triangle'; break;
      default: backgroundColor = 'var(--primary-color)'; iconClass = 'fas fa-info-circle';
    }
    Toastify({
      text: `<i class="${iconClass}" style="margin-right: 8px;"></i> ${message}`,
      duration: duration, close: true, gravity: "top", position: "right",
      stopOnFocus: true, escapeMarkup: false,
      style: { background: backgroundColor, borderRadius: '5px', boxShadow: '0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23)' },
    }).showToast();
  }

  function getFilteredLokality() {
    const typFilter = document.getElementById('filter').value;
    const searchFilter = document.getElementById('searchFilter').value.toLowerCase();
    return lokality.filter(l => {
        const matchesType = !typFilter || l.typ === typFilter;
        const matchesSearch = !searchFilter ||
                                (l.name && l.name.toLowerCase().includes(searchFilter)) ||
                                (l.adresa && l.adresa.toLowerCase().includes(searchFilter)) ||
                                (l.polis && l.polis.toLowerCase().includes(searchFilter));
        return matchesType && matchesSearch;
      });
  }

  function zobrazMapu() {
    markers.forEach(m => mapa.removeLayer(m));
    markers.length = 0;
    const filteredLokality = getFilteredLokality();

    filteredLokality.forEach(l => {
      const icon = markerIcons[l.typ] || markerIcons['default'];
      const m = L.marker([l.lat, l.lng], { icon: icon }).addTo(mapa)
        .bindPopup(`<strong>${l.name||'N/A'}</strong><br>Mesto: ${l.polis||'N/A'}<br>Adresa: ${l.adresa||'N/A'}<br>V칳kon: ${l.vykon===null||l.vykon===undefined ? 'N/A' : l.vykon} kW<br>Konektory: ${l.konektory||'N/A'}<br>Typ: ${l.typ||'N/A'}<br>Prev치dzkovate: ${l.prevadzkovatel||'N/A'}<br>ID: ${l.id_bodu||'N/A'}<br>Autentifik치cia: ${l.autentifikacia||'N/A'}<br>Platba: ${l.platba||'N/A'}<br>Kontakt: ${l.kontakt||'N/A'}<br>Doba prev치dzky: ${l.prevadzka||'N/A'}<br>Uveden칠 do prev치dzky: ${l.datum||'N/A'}<br><div style="margin-top: 10px; display: flex; gap: 8px;"><button class="edit-btn btn" data-id="${l.id}"><i class="fas fa-edit"></i> Upravi콘</button><button class="delete-btn btn" data-id="${l.id}"><i class="fas fa-trash-alt"></i> Vymaza콘</button></div>`);
      markers.push(m);

      m.on('popupopen', () => {
        const popupElement = m.getPopup().getElement();
        const editBtn = popupElement.querySelector('.edit-btn');
        const deleteBtn = popupElement.querySelector('.delete-btn');
        const lokalitaId = editBtn.dataset.id;

        if (editBtn) {
          editBtn.onclick = (e) => { e.stopPropagation(); const originalIndex = lokality.findIndex(loc => loc.id === lokalitaId); if (originalIndex !== -1) editLokalita(originalIndex); mapa.closePopup(); };
        }
        if (deleteBtn) {
          deleteBtn.onclick = (e) => { e.stopPropagation(); const originalIndex = lokality.findIndex(loc => loc.id === lokalitaId); if (originalIndex !== -1) deleteLokalita(originalIndex); mapa.closePopup(); };
        }
      });
    });

    if (filteredLokality.length > 0) {
        if (filteredLokality.length === 1) { mapa.setView([filteredLokality[0].lat, filteredLokality[0].lng], 14); }
        else { const bounds = L.latLngBounds(filteredLokality.map(l => [l.lat, l.lng])); mapa.fitBounds(bounds, { padding: [50, 50] }); }
    } else {
        mapa.setView(defaultMapView.center, defaultMapView.zoom);
    }
  }

  function zobrazZoznam() {
    const container = document.getElementById('zoznamLokalit');
    container.innerHTML = '';
    const filteredLokality = getFilteredLokality();

    if (filteredLokality.length === 0) {
        container.innerHTML = '<div class="no-results-message">Nena코li sa 쬴adne lokality.</div>';
        return;
    }

    filteredLokality.forEach(l => {
      const el = document.createElement('div');
      el.className = 'lokalita';
      el.innerHTML = `<div class="lokalita-info"><strong>${l.name||'N/A'}</strong><br><small>Mesto: ${l.polis||'N/A'}<br>V칳kon: ${l.vykon===null||l.vykon===undefined ?'N/A':l.vykon} kW<br>Typ: ${l.typ||'N/A'}</small></div><div class="lokalita-actions"><button class="edit-btn" data-id="${l.id}" aria-label="Upravi콘 ${l.name}"><i class="fas fa-edit"></i></button><button class="delete-btn" data-id="${l.id}" aria-label="Vymaza콘 ${l.name}"><i class="fas fa-trash-alt"></i></button></div>`;
      el.querySelector('.lokalita-info').onclick = () => mapa.setView([l.lat, l.lng], 14);
      el.querySelector('.edit-btn').onclick = (e) => { e.stopPropagation(); const originalIndex = lokality.findIndex(loc => loc.id === l.id); if (originalIndex !== -1) editLokalita(originalIndex); };
      el.querySelector('.delete-btn').onclick = (e) => { e.stopPropagation(); const originalIndex = lokality.findIndex(loc => loc.id === l.id); if (originalIndex !== -1) deleteLokalita(originalIndex); };
      container.appendChild(el);
    });
  }

  const debouncedAktualizujUI = debounce(aktualizujUI, 300);

  function aktualizujUI() {
    localStorage.setItem("lokalityPSK", JSON.stringify(lokality));
    if (tempMarker) { tempMarker.remove(); tempMarker = null; } // Odstr치ni콘 do캜asn칳 marker
    zobrazMapu();
    zobrazZoznam();
  }

  function ulozLokality() {
    if (lokality.length === 0) {
        showToast("Nie s칰 k dispoz칤cii 쬴adne d치ta na z치lohovanie.", 'warning');
        return;
    }
    const data = JSON.stringify(lokality, null, 2);
    const blob = new Blob([data], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'zalohy_lokality_PSK.json'; a.click();
    URL.revokeObjectURL(url);
    showToast("D치ta boli ulo쬰n칠 a z치lohovan칠 do s칰boru.", 'success');
  }

  function clearAllData() {
      if (confirm("Naozaj chcete vymaza콘 v코etky ulo쬰n칠 d치ta lokal칤t? T치to akcia je nevratn치!")) {
          localStorage.removeItem('lokalityPSK'); lokality = []; aktualizujUI();
          showToast("V코etky d치ta boli vymazan칠.", 'warning');
      }
  }

  function deleteLokalita(index) {
    if (confirm(`Naozaj chcete vymaza콘 lokalitu "${lokality[index].name}"?`)) {
      lokality.splice(index, 1); aktualizujUI();
      showToast("Lokalita bola 칰spe코ne vymazan치.", 'success');
    }
  }

  const editModal = document.getElementById('editModal');
  const addModal = document.getElementById('addModal');
  const welcomeModal = document.getElementById('welcomeModal');

  function openModal(modalElement, formToReset = null) {
    if (formToReset) formToReset.reset();
    modalElement.style.display = 'block';
    modalElement.querySelector('input, select, textarea, button')?.focus();
  }

  function closeModal(modalElement) {
    modalElement.style.display = 'none';
  }

  document.getElementById('closeEditModal').onclick = () => { if (confirm("Naozaj chcete zatvori콘 okno? Neulo쬰n칠 zmeny sa stratia.")) { closeModal(editModal); } };
  document.getElementById('closeEditModal').onkeydown = (e) => { if (e.key === 'Enter' || e.key === ' ') { if (confirm("Naozaj chcete zatvori콘 okno? Neulo쬰n칠 zmeny sa stratia.")) { closeModal(editModal); } } };

  function editLokalita(index) {
    const l = lokality[index];
    document.getElementById('editIndex').value = index;
    document.getElementById('editId').value = l.id;
    document.getElementById('editName').value = l.name || '';
    document.getElementById('editLat').value = l.lat || '';
    document.getElementById('editLng').value = l.lng || '';
    document.getElementById('editPolis').value = l.polis || '';
    document.getElementById('editVykon').value = l.vykon === null || l.vykon === undefined ? '' : l.vykon;
    document.getElementById('editKonektory').value = l.konektory || '';
    document.getElementById('editTyp').value = l.typ || 'AC';
    document.getElementById('editAdresa').value = l.adresa || '';
    document.getElementById('editPrevadzkovatel').value = l.prevadzkovatel || '';
    document.getElementById('editIdBodu').value = l.id_bodu || '';
    document.getElementById('editAutentifikacia').value = l.autentifikacia || '';
    document.getElementById('editPlatba').value = l.platba || '';
    document.getElementById('editKontakt').value = l.kontakt || '';
    document.getElementById('editPrevadzka').value = l.prevadzka || '';
    document.getElementById('editDatum').value = l.datum || '';
    openModal(editModal);
  }

  document.getElementById('editForm').onsubmit = (e) => {
    e.preventDefault();
    if (!e.target.checkValidity()) { showToast("Pros칤m, opravte chyby vo formul치ri.", 'error'); return; }
    const index = document.getElementById('editIndex').value;
    const id = document.getElementById('editId').value;
    const updatedLokalita = {
      id: id, name: document.getElementById('editName').value.trim(),
      lat: parseFloat(document.getElementById('editLat').value), lng: parseFloat(document.getElementById('editLng').value),
      polis: document.getElementById('editPolis').value.trim(), vykon: document.getElementById('editVykon').value === '' ? null : parseFloat(document.getElementById('editVykon').value),
      konektory: document.getElementById('editKonektory').value.trim(), typ: document.getElementById('editTyp').value,
      adresa: document.getElementById('editAdresa').value.trim(), prevadzkovatel: document.getElementById('editPrevadzkovatel').value.trim(),
      id_bodu: document.getElementById('editIdBodu').value.trim(), autentifikacia: document.getElementById('editAutentifikacia').value.trim(),
      platba: document.getElementById('editPlatba').value.trim(), kontakt: document.getElementById('editKontakt').value.trim(),
      prevadzka: document.getElementById('editPrevadzka').value.trim(), datum: document.getElementById('editDatum').value.trim()
    };
    lokality[index] = updatedLokalita;
    aktualizujUI(); closeModal(editModal);
    showToast("Lokalita bola 칰spe코ne aktualizovan치.", 'success');
  };
  
  const showAddModalBtn = document.getElementById('showAddModalBtn');
  const addModeGuide = document.getElementById('add-mode-guide');
  const addForm = document.getElementById('addForm');
  const closeAddModalButton = document.getElementById('closeAddModal');
  const addressLoader = document.getElementById('address-loader');
  
  function enterAddMode() {
      isAddingLocationMode = true;
      mapa.getContainer().style.cursor = 'crosshair';
      showAddModalBtn.classList.add('cancel-mode');
      showAddModalBtn.innerHTML = '<i class="fas fa-times"></i> Zru코i콘 prid치vanie';
      addModeGuide.style.display = 'block';
  }
  
  function exitAddMode() {
      isAddingLocationMode = false;
      mapa.getContainer().style.cursor = '';
      showAddModalBtn.classList.remove('cancel-mode');
      showAddModalBtn.innerHTML = '<i class="fas fa-plus-circle"></i> Prida콘 nov칰 lokalitu';
      addModeGuide.style.display = 'none';
      if (tempMarker) {
          tempMarker.remove();
          tempMarker = null;
      }
  }

  showAddModalBtn.onclick = () => {
    if (isAddingLocationMode) {
      exitAddMode();
      showToast('Prid치vanie lokality bolo zru코en칠.', 'warning');
    } else {
      enterAddMode();
    }
  };

  mapa.on('click', async (e) => {
    if (isAddingLocationMode) {
      exitAddMode(); 
      
      const latlng = e.latlng;
      if (tempMarker) { tempMarker.remove(); }
      tempMarker = L.marker(latlng, { icon: markerIcons.temp, opacity: 0.7 }).addTo(mapa);
      
      openModal(addModal, addForm);
      document.getElementById('addLat').value = latlng.lat.toFixed(6);
      document.getElementById('addLng').value = latlng.lng.toFixed(6);

      addressLoader.style.display = 'block';
      document.getElementById('addPolis').value = '';
      document.getElementById('addAdresa').value = '';
      try {
        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latlng.lat}&lon=${latlng.lng}`);
        if (!response.ok) throw new Error('Network response was not ok');
        const data = await response.json();
        const adresa = data.address;
        const ulica = adresa.road || '';
        const cislo = adresa.house_number || '';
        document.getElementById('addAdresa').value = `${ulica} ${cislo}`.trim();
        document.getElementById('addPolis').value = adresa.city || adresa.town || adresa.village || adresa.county || '';
        showToast("Adresa bola automaticky na캜칤tan치.", 'success');
      } catch (error) {
        showToast("Nepodarilo sa automaticky na캜칤ta콘 adresu.", 'error');
      } finally {
        addressLoader.style.display = 'none';
        document.getElementById('addName').focus();
      }
    }
  });

  closeAddModalButton.onclick = () => {
    if (confirm("Naozaj chcete zatvori콘 okno? Neulo쬰n칠 zmeny sa stratia.")) {
        closeModal(addModal);
        if (tempMarker) { tempMarker.remove(); tempMarker = null; }
    }
  };

  addForm.onsubmit = (e) => {
    e.preventDefault();
    if (!addForm.checkValidity()) { showToast("Pros칤m, opravte chyby vo formul치ri.", 'error'); return; }

    const newLokalita = {
      id: crypto.randomUUID(),
      name: document.getElementById('addName').value.trim(),
      lat: parseFloat(document.getElementById('addLat').value),
      lng: parseFloat(document.getElementById('addLng').value),
      polis: document.getElementById('addPolis').value.trim(),
      vykon: document.getElementById('addVykon').value === '' ? null : parseFloat(document.getElementById('addVykon').value),
      konektory: document.getElementById('addKonektory').value.trim(),
      typ: document.getElementById('addTyp').value,
      adresa: document.getElementById('addAdresa').value.trim(),
      prevadzkovatel: document.getElementById('addPrevadzkovatel').value.trim(),
      id_bodu: document.getElementById('addIdBodu').value.trim(),
      autentifikacia: document.getElementById('addAutentifikacia').value.trim(),
      platba: document.getElementById('addPlatba').value.trim(),
      kontakt: document.getElementById('addKontakt').value.trim(),
      prevadzka: document.getElementById('addPrevadzka').value.trim(),
      datum: document.getElementById('addDatum').value.trim()
    };
    
    lokality.push(newLokalita);
    aktualizujUI(); 
    closeModal(addModal);
    showToast("Nov치 lokalita bola 칰spe코ne pridan치.", 'success');
  };
  
  document.getElementById('fileInput').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    loadingSpinner.style.display = 'block';

    try {
        if (!confirm("Naozaj chcete importova콘 d치ta z Excelu? T칳mto sa prep칤코u v코etky aktu치lne neulo쬰n칠 d치ta.")) {
            e.target.value = ''; // Reset input
            loadingSpinner.style.display = 'none';
            return;
        }

        const rows = await readXlsxFile(file);
        const header = rows[0].map(h => String(h).trim().toLowerCase());
        const expectedHeader = Object.keys(requiredColumns);

        const missingColumns = expectedHeader.filter(col => !header.includes(col));
        if (missingColumns.length > 0) {
            throw new Error(`Ch칳baj칰ce st컄pce v s칰bore: ${missingColumns.join(', ')}`);
        }
        
        const headerIndexMap = {};
        expectedHeader.forEach(col => {
            headerIndexMap[col] = header.indexOf(col);
        });

        const importedLokality = rows.slice(1).map(row => {
            const getVal = (colName) => row[headerIndexMap[colName]];
            
            const lat = parseFloat(getVal('lat'));
            const lng = parseFloat(getVal('lng'));
            const vykonVal = getVal('vykon');

            if (isNaN(lat) || isNaN(lng)) {
                console.warn('Preskakujem riadok s neplatn칳mi s칰radnicami:', row);
                return null;
            }
            
            return {
                id: crypto.randomUUID(),
                name: String(getVal('name') || ''),
                lat: lat,
                lng: lng,
                polis: String(getVal('polis') || ''),
                vykon: (vykonVal === null || vykonVal === undefined || String(vykonVal).trim() === '') ? null : parseFloat(vykonVal),
                konektory: String(getVal('konektory') || ''),
                typ: String(getVal('typ') || 'AC'),
                adresa: String(getVal('adresa') || ''),
                prevadzkovatel: String(getVal('prevadzkovatel') || ''),
                id_bodu: String(getVal('id_bodu') || ''),
                autentifikacia: String(getVal('autentifikacia') || ''),
                platba: String(getVal('platba') || ''),
                kontakt: String(getVal('kontakt') || ''),
                prevadzka: String(getVal('prevadzka') || ''),
                datum: String(getVal('datum') || '')
            };
        }).filter(item => item !== null);

        lokality = importedLokality;
        aktualizujUI();
        showToast(`Import 칰spe코n칳. Na캜칤talo sa ${lokality.length} lokal칤t.`, 'success');
    } catch (error) {
        console.error("Chyba pri importe z Excelu:", error);
        showToast(`Chyba pri importe: ${error.message}`, 'error', 5000);
    } finally {
        loadingSpinner.style.display = 'none';
        e.target.value = ''; 
    }
  });

  document.getElementById('jsonInput').addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;

    if (!confirm("Naozaj chcete obnovi콘 d치ta zo z치lohy? T칳mto sa prep칤코u v코etky aktu치lne neulo쬰n칠 d치ta.")) {
        e.target.value = '';
        return;
    }

    const reader = new FileReader();
    reader.onload = (event) => {
        try {
            const data = JSON.parse(event.target.result);
            if (!Array.isArray(data)) {
                 throw new Error("S칰bor JSON neobsahuje pole (array) d치t.");
            }
            lokality = data;
            aktualizujUI();
            showToast("D치ta boli 칰spe코ne obnoven칠 zo z치lohy.", 'success');
        } catch (error) {
            console.error("Chyba pri importe zo JSON:", error);
            showToast(`Chyba pri spracovan칤 JSON s칰boru: ${error.message}`, 'error', 5000);
        } finally {
            e.target.value = '';
        }
    };
    reader.onerror = () => {
        showToast("Nepodarilo sa pre캜칤ta콘 s칰bor.", 'error');
        e.target.value = '';
    };
    reader.readAsText(file);
  });

  document.getElementById('exportBtn').addEventListener('click', () => {
    if (lokality.length === 0) {
        showToast("Nie s칰 k dispoz칤cii 쬴adne d치ta na export.", 'warning');
        return;
    }

    const dataToExport = lokality.map(l => ({
        name: l.name || '', lat: l.lat, lng: l.lng, polis: l.polis || '',
        vykon: l.vykon, konektory: l.konektory || '', typ: l.typ || '',
        adresa: l.adresa || '', prevadzkovatel: l.prevadzkovatel || '',
        id_bodu: l.id_bodu || '', autentifikacia: l.autentifikacia || '',
        platba: l.platba || '', kontakt: l.kontakt || '', prevadzka: l.prevadzka || '',
        datum: l.datum || ''
    }));

    try {
        const worksheet = XLSX.utils.json_to_sheet(dataToExport);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Lokality_PSK");

        const colWidths = Object.keys(dataToExport[0]).map(key => {
            const max_width = dataToExport.reduce((w, r) => Math.max(w, r[key] ? String(r[key]).length : 10), key.length);
            return { wch: max_width + 2 };
        });
        worksheet['!cols'] = colWidths;

        XLSX.writeFile(workbook, "export_lokality_PSK.xlsx");
        showToast("D치ta boli 칰spe코ne exportovan칠 do Excelu.", 'success');
    } catch (error) {
        console.error("Chyba pri exporte do Excelu:", error);
        showToast("Vyskytla sa chyba pri exporte do Excelu.", 'error');
    }
  });
  
  document.getElementById('printListBtn').addEventListener('click', () => {
    const filteredLokality = getFilteredLokality();
    if (filteredLokality.length === 0) {
      showToast('Nie je 캜o tla캜i콘. Zoznam je pr치zdny.', 'warning');
      return;
    }

    const printWindow = window.open('', '', 'height=800,width=1200');
    printWindow.document.write('<html><head><title>Zoznam Lokal칤t</title>');
    printWindow.document.write('<style>@media print{@page{size: A4 landscape; margin: 10mm;}}body{font-family: Arial, sans-serif; font-size: 10pt;}header{display:flex;align-items:center;margin-bottom:20px}header img{height:50px;margin-right:20px}h2{margin:0}table{border-collapse:collapse;width:100%;}th,td{border:1px solid #ccc;padding:8px;text-align:left;}th{background-color:#f2f2f2;}</style>');
    printWindow.document.write('</head><body>');
    printWindow.document.write('<header><img src="https://i.imgur.com/VO7B8Gw.png" alt="Logo"><h2>EKO-doprava v PSK - Zoznam Lokal칤t</h2></header>');
    printWindow.document.write('<table><thead><tr><th>N치zov</th><th>Mesto</th><th>Adresa</th><th>Typ</th><th>V칳kon (kW)</th><th>Konektory</th><th>Prev치dzkovate</th></tr></thead><tbody>');

    filteredLokality.forEach(l => {
        printWindow.document.write(`<tr><td>${l.name||'N/A'}</td><td>${l.polis||'N/A'}</td><td>${l.adresa||'N/A'}</td><td>${l.typ||'N/A'}</td><td>${l.vykon===null||l.vykon===undefined ?'N/A':l.vykon}</td><td>${l.konektory||'N/A'}</td><td>${l.prevadzkovatel||'N/A'}</td></tr>`);
    });

    printWindow.document.write('</tbody></table>');
    printWindow.document.write('</body></html>');
    printWindow.document.close();
    printWindow.focus(); 
    setTimeout(() => { printWindow.print(); printWindow.close(); }, 250);
  });

  const toggleSidebarBtn = document.getElementById('toggleSidebar');
  toggleSidebarBtn.addEventListener('click', () => {
    const sidebar = document.getElementById('sidebar');
    const obsah = document.getElementById('obsah');
    sidebar.classList.toggle('collapsed');
    obsah.classList.toggle('fullscreen');
    const isCollapsed = sidebar.classList.contains('collapsed');
    toggleSidebarBtn.setAttribute('aria-expanded', !isCollapsed);
    if (isCollapsed) { toggleSidebarBtn.innerHTML = '<i class="fas fa-chevron-left"></i>'; toggleSidebarBtn.title = 'Zobrazi콘 panel'; } 
    else { toggleSidebarBtn.innerHTML = '<i class="fas fa-chevron-right"></i>'; toggleSidebarBtn.title = 'Skry콘 panel'; }
    setTimeout(() => mapa.invalidateSize(), 310);
  });

  const basemapSwitcherHeader = document.querySelector('.basemap-switcher-header');
  basemapSwitcherHeader.addEventListener('click', () => {
      document.querySelector('.basemap-options').classList.toggle('hidden');
      basemapSwitcherHeader.querySelector('i').classList.toggle('rotated');
  });
  document.getElementById('basemap-switcher').addEventListener('change', (e) => {
    if (e.target.name === 'basemap') {
      mapa.removeLayer(currentBasemap);
      switch (e.target.value) {
        case 'osm': currentBasemap = osmLayer.addTo(mapa); break;
        case 'google-streets': currentBasemap = googleStreets.addTo(mapa); break;
        case 'google-satellite': currentBasemap = googleSat.addTo(mapa); break;
        case 'google-hybrid': currentBasemap = googleHybrid.addTo(mapa); break;
        default: currentBasemap = osmLayer.addTo(mapa);
      }
    }
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && isAddingLocationMode) {
      exitAddMode();
      showToast('Prid치vanie lokality bolo zru코en칠.', 'warning');
    }
  });

  document.getElementById('filter').addEventListener('change', aktualizujUI);
  document.getElementById('searchFilter').addEventListener('input', debouncedAktualizujUI);

  // =========================================================================
  // ====================== INICIALIZA캛N츼 FUNKCIA APLIK츼CIE ==================
  // =========================================================================
  /**
   * Inicializuje aplik치ciu.
   * Pok칰si sa na캜칤ta콘 d치ta o lokalit치ch z extern칠ho JSON s칰boru ('zalohy_lokality_PSK.json').
   * Tento s칰bor by sa mal nach치dza콘 v rovnakom adres치ri ako HTML s칰bor.
   * Ak na캜칤tanie zlyh치 (napr. s칰bor neexistuje), ako z치lo쬹칠 rie코enie na캜칤ta d치ta
   * z lok치lneho 칰lo쬴ska prehliada캜a (localStorage).
   * N치sledne aktualizuje pou쮂셨ate쬽k칠 rozhranie a zobraz칤 칰vodn칠 okno pri prvej n치v코teve.
   */
  async function initializeApp() {
    // Pokus o na캜칤tanie d치t z extern칠ho s칰boru zalohy_lokality_PSK.json
    try {
        const response = await fetch('zalohy_lokality_PSK.json', {
            // Hlavi캜ka 'Cache-Control: no-cache' zabezpe캜칤, 쬰 prehliada캜
            // v쬯y na캜칤ta najnov코iu verziu s칰boru priamo zo servera.
            cache: 'no-cache'
        });

        // Skontroluje, 캜i bol s칰bor 칰spe코ne n치jden칳 a na캜칤tan칳 (HTTP status 200-299)
        if (!response.ok) {
            throw new Error(`S칰bor 'zalohy_lokality_PSK.json' sa nepodarilo na캜칤ta콘. Status: ${response.status}`);
        }

        // Prevedie odpove캞 zo servera na form치t JSON
        const dataFromFile = await response.json();
        
        // Over칤, 캜i d치ta v s칰bore s칰 vo form치te po쬬 (array)
        if (!Array.isArray(dataFromFile)) {
            throw new Error('Form치t d치t v s칰bore z치lohy nie je spr치vny (o캜ak치va sa pole).');
        }

        // Ak v코etko prebehlo v poriadku, prirad칤 na캜칤tan칠 d치ta do hlavnej premennej
        lokality = dataFromFile;
        showToast("D치ta boli 칰spe코ne na캜칤tan칠 zo s칰boru z치lohy.", 'success');

    } catch (error) {
        // T치to 캜as콘 k칩du sa vykon치, ak nastala ak치ko쭀ek chyba v 'try' bloku
        console.warn("Chyba pri na캜칤tan칤 externej z치lohy:", error.message);
        
        // Ako z치lo쬹칠 rie코enie sa pok칰si na캜칤ta콘 d치ta z lok치lneho 칰lo쬴ska
        const localData = localStorage.getItem("lokalityPSK");
        lokality = localData ? JSON.parse(localData) : [];
        
        showToast("Extern칰 z치lohu sa nepodarilo na캜칤ta콘. Obnovuj칰 sa d치ta z lok치lneho 칰lo쬴ska.", 'warning');
    }

    // Po na캜칤tan칤 d치t (bu캞 zo s칰boru alebo z localStorage) sa aktualizuje cel치 mapa a zoznam
    aktualizujUI();

    // Zobrazenie 칰vodn칠ho okna, ak pou쮂셨ate nav코t칤vil str치nku prv칳kr치t v r치mci session
    const hasVisited = sessionStorage.getItem('hasVisitedEcoTransportMap');
    if (!hasVisited) {
        openModal(welcomeModal);
    }

    // Nastavenie funkcionality pre tla캜idlo na zatvorenie 칰vodn칠ho okna
    document.getElementById('closeWelcomeModal').addEventListener('click', () => {
        closeModal(welcomeModal);
        sessionStorage.setItem('hasVisitedEcoTransportMap', 'true');
        // Prepo캜칤ta ve쬶os콘 mapy po zatvoren칤 mod치lneho okna, aby sa predi코lo chyb치m v zobrazen칤
        mapa.invalidateSize();
    });
  }

  // Spustenie inicializa캜nej funkcie hne캞 po na캜칤tan칤 celej str치nky
initializeApp();

</script>
</body>
</html>
