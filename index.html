<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EKO-doprava v PSK - Mapa Lokalít</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

  <style>
    /* CSS Variabilita - Moderná Paleta */
    :root {
      --primary-color: #4285F4; /* Google Blue */
      --primary-dark-color: #0056b3; /* Tmavší odtieň modrej */
      --accent-color: #34A853; /* Google Green pre úspech */
      --danger-color: #EA4335; /* Google Red pre chyby */
      --warning-color: #FBBC04; /* Google Yellow pre varovania */
      --text-color: #333;
      --light-text-color: #555;
      --bg-color: #f8f9fa; /* Svetlé pozadie */
      --card-bg-color: #ffffff; /* Biele pozadie pre karty */
      --border-color: #e0e0e0;
      --shadow-light: 0 2px 4px rgba(0, 0, 0, 0.08);
      --shadow-medium: 0 4px 8px rgba(0, 0, 0, 0.1);
      --font-family: 'Inter', sans-serif;
    }

    body {
      font-family: var(--font-family);
      margin: 0;
      padding: 0;
      background-color: var(--bg-color);
      color: var(--text-color);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Základné rozloženie */
    .container {
      display: flex;
      flex-grow: 1;
      height: 100vh;
      overflow: hidden;
    }

    /* Bočný panel */
    #sidebar {
      width: 320px;
      background-color: var(--card-bg-color);
      padding: 20px;
      box-shadow: var(--shadow-medium);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 20px;
      position: relative; /* For toggle button */
      transition: width 0.3s ease-in-out;
      flex-shrink: 0; /* Prevent sidebar from shrinking */
    }

    #sidebar.hidden {
      width: 0;
      padding: 0;
      overflow: hidden;
    }

    #sidebar-toggle {
      position: absolute;
      top: 15px;
      right: -45px; /* Position outside sidebar */
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 0 5px 5px 0;
      padding: 10px 10px 10px 5px;
      cursor: pointer;
      font-size: 1.2em;
      box-shadow: var(--shadow-medium);
      z-index: 1001; /* Above map */
      transition: right 0.3s ease-in-out;
    }

    #sidebar.hidden + #sidebar-toggle {
      right: 0; /* Move button to edge when sidebar is hidden */
    }

    .sidebar-header {
      text-align: center;
      margin-bottom: 20px;
    }

    .sidebar-header h2 {
      color: var(--primary-color);
      margin-bottom: 5px;
      font-weight: 700;
    }

    .sidebar-header p {
      color: var(--light-text-color);
      font-size: 0.9em;
    }

    .filter-section, .search-section, .basemap-section {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--light-text-color);
    }

    select, input[type="text"], input[type="search"] {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 1em;
      box-sizing: border-box; /* Include padding in width */
      background-color: var(--bg-color);
      color: var(--text-color);
      transition: border-color 0.2s;
    }

    select:focus, input[type="text"]:focus, input[type="search"]:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.2);
    }

    /* Výpis lokalít */
    #lokality-list {
      flex-grow: 1; /* Allow list to take available space */
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-top: 10px;
    }

    .lokalita-item {
      background-color: var(--card-bg-color);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      padding: 15px;
      box-shadow: var(--shadow-light);
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .lokalita-item:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-medium);
    }

    .lokalita-item h3 {
      margin-top: 0;
      margin-bottom: 8px;
      color: var(--primary-color);
      font-size: 1.15em;
      font-weight: 600;
    }

    .lokalita-item p {
      margin-bottom: 5px;
      font-size: 0.95em;
      color: var(--light-text-color);
    }

    .lokalita-item .type-tag {
      display: inline-block;
      background-color: var(--accent-color);
      color: white;
      padding: 4px 8px;
      border-radius: 5px;
      font-size: 0.8em;
      margin-top: 10px;
      font-weight: 500;
    }

    /* Mapa */
    #mapa {
      flex-grow: 1;
      height: 100vh;
      z-index: 1; /* Ensure map is behind sidebar toggle */
    }

    /* Leaflet Popups - Moderný Vzhľad */
    .leaflet-popup-content-wrapper {
      border-radius: 10px;
      padding: 15px;
      box-shadow: var(--shadow-medium);
      background-color: var(--card-bg-color);
      color: var(--text-color);
      font-family: var(--font-family);
    }

    .leaflet-popup-content h3 {
      color: var(--primary-color);
      margin-top: 0;
      margin-bottom: 10px;
      font-size: 1.2em;
      font-weight: 600;
    }

    .leaflet-popup-content p {
      margin-bottom: 5px;
      font-size: 0.9em;
      line-height: 1.4;
      color: var(--light-text-color);
    }

    .leaflet-popup-tip {
      background-color: var(--card-bg-color);
    }

    /* Tooltip pre ikonky */
    .icon-tooltip {
      position: absolute;
      background-color: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 0.8em;
      white-space: nowrap;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
    }

    .icon-wrapper:hover .icon-tooltip {
      opacity: 1;
    }

    /* Modálne okno */
    .modal {
      display: none; /* Hidden by default */
      position: fixed; /* Stay in place */
      z-index: 2000; /* Sit on top */
      left: 0;
      top: 0;
      width: 100%; /* Full width */
      height: 100%; /* Full height */
      overflow: auto; /* Enable scroll if needed */
      background-color: rgba(0, 0, 0, 0.6); /* Black w/ opacity */
      justify-content: center;
      align-items: center;
      padding: 20px; /* Padding for smaller screens */
    }

    .modal-content {
      background-color: var(--card-bg-color);
      margin: auto;
      padding: 30px;
      border-radius: 12px;
      box-shadow: var(--shadow-medium);
      max-width: 600px;
      width: 90%;
      text-align: center;
      position: relative;
      animation: fadeIn 0.3s ease-out;
    }

    .modal-content h2 {
      color: var(--primary-color);
      margin-bottom: 20px;
      font-size: 1.8em;
      font-weight: 700;
    }

    .modal-content p {
      color: var(--light-text-color);
      font-size: 1.1em;
      line-height: 1.6;
      margin-bottom: 25px;
    }

    .modal-content .close-button {
      background-color: var(--primary-color);
      color: white;
      padding: 12px 25px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1.1em;
      font-weight: 600;
      transition: background-color 0.2s ease, transform 0.2s ease;
    }

    .modal-content .close-button:hover {
      background-color: var(--primary-dark-color);
      transform: translateY(-2px);
    }

    /* Animácie */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Responzívny dizajn */
    @media (max-width: 768px) {
      .container {
        flex-direction: column;
      }

      #sidebar {
        width: 100%;
        height: auto;
        max-height: 50vh; /* Allow sidebar to scroll on small screens */
        position: static; /* No absolute positioning for toggle */
        padding-bottom: 60px; /* Space for toggle if it moves */
      }

      #sidebar.hidden {
        height: 0;
        max-height: 0;
        padding: 0;
      }

      #sidebar-toggle {
        position: fixed; /* Keep button visible */
        bottom: 15px; /* At the bottom */
        right: 15px; /* At the right */
        top: unset; /* Remove top positioning */
        border-radius: 50%;
        padding: 15px;
        font-size: 1.5em;
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: var(--shadow-medium);
        z-index: 1002;
        transition: transform 0.2s ease;
      }

      #sidebar-toggle:hover {
        transform: scale(1.05);
      }

      #sidebar.hidden + #sidebar-toggle {
        right: 15px; /* Stays at the same position */
      }

      #mapa {
        height: 50vh; /* Take remaining space */
      }
    }
  </style>
</head>
<body>

  <div class="container">
    <div id="sidebar">
      <div class="sidebar-header">
        <h2>EKO-doprava v PSK</h2>
        <p>Mapa lokalít pre nabíjacie stanice, cyklostojany a cyklotrasy.</p>
      </div>

      <div class="filter-section">
        <label for="filter">Filtrovať podľa typu:</label>
        <select id="filter">
          <option value="all">Všetky</option>
          <option value="nabijacia-stanica">Nabíjacia stanica</option>
          <option value="stojan-na-bicykle">Stojan na bicykle</option>
          <option value="cyklotrasa">Cyklotrasa</option>
        </select>
      </div>

      <div class="search-section">
        <label for="searchFilter">Hľadať:</label>
        <input type="search" id="searchFilter" placeholder="Zadajte názov, adresu alebo mesto...">
      </div>

      <div class="basemap-section">
        <label for="basemapSelector">Vyberte podkladovú mapu:</label>
        <select id="basemapSelector">
          <option value="osm">OpenStreetMap</option>
          <option value="google-streets">Google Maps (Cesty)</option>
          <option value="google-satellite">Google Maps (Satelit)</option>
          <option value="google-hybrid">Google Maps (Hybrid)</option>
        </select>
      </div>

      <div id="lokality-list">
        </div>
    </div>

    <button id="sidebar-toggle">
      <i class="fas fa-bars"></i>
    </button>

    <div id="mapa"></div>
  </div>

  <div id="welcomeModal" class="modal">
    <div class="modal-content">
      <h2>Vitajte na mape EKO-dopravy v PSK!</h2>
      <p>Táto interaktívna mapa vám pomôže objavovať a lokalizovať kľúčové body infraštruktúry pre ekologickú dopravu v Prešovskom kraji, vrátane nabíjacích staníc pre elektromobily, stojanov na bicykle a cyklotrás.</p>
      <p>Používajte filtre a vyhľadávanie na ľavej strane, aby ste našli presne to, čo potrebujete. Kliknutím na značku na mape získate podrobné informácie o danom mieste.</p>
      <button id="closeWelcomeModal" class="close-button">Začať prehliadať</button>
    </div>
  </div>


  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />


  <script>
    // Global variable to store all loaded data
    let allLokalityData = [];
    let mapa;
    let markers = L.markerClusterGroup(); // Initialize MarkerClusterGroup
    let currentBasemap;

    // Google Maps vrstvy
    let googleStreets = L.tileLayer('http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
      maxZoom: 20,
      subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
    });
    let googleSat = L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
      maxZoom: 20,
      subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
    });
    let googleHybrid = L.tileLayer('http://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}', {
      maxZoom: 20,
      subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
    });
    let osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    });

    // Funkcia na načítanie JSON dát
    async function nacitajLokalityData() {
      try {
        // Cesta k JSON súboru. Ak je v rovnakom priečinku, stačí názov súboru.
        const response = await fetch('./zalohy_lokality_PSK.json');
        if (!response.ok) {
          throw new Error(`HTTP chyba! Status: ${response.status}`);
        }
        allLokalityData = await response.json();
        console.log('Dáta načítané:', allLokalityData); // Pre debug
        aktualizujUI(); // Aktualizujeme UI po načítaní dát
      } catch (error) {
        console.error('Nepodarilo sa načítať dáta o lokalitách:', error);
        Toastify({
          text: "Chyba pri načítaní dát o lokalitách. Skúste to prosím neskôr.",
          duration: 3000,
          close: true,
          gravity: "top", // `top` or `bottom`
          position: "right", // `left`, `center` or `right`
          backgroundColor: "linear-gradient(to right, #EA4335, #DC2B1B)", // Použi priamo farby pre Toastify
        }).showToast();
      }
    }


    // Funkcie pre modálne okno
    const welcomeModal = document.getElementById('welcomeModal');

    function openModal(modal) {
      modal.style.display = 'flex'; // Zobrazí modal ako flexbox
      // Pre správne zobrazenie mapy, keď je modal otvorený
      setTimeout(() => mapa.invalidateSize(), 0);
    }

    function closeModal(modal) {
      modal.style.display = 'none';
      mapa.invalidateSize(); // Opätovne prekreslí mapu po zatvorení modalu
    }


    // Funkcia pre vytvorenie ikonky
    function getMarkerIcon(type) {
      let iconHtml = '';
      let className = 'custom-marker';
      let tooltipText = '';

      switch (type) {
        case 'nabijacia-stanica':
          iconHtml = '<i class="fa-solid fa-charging-station"></i>';
          className += ' charging-station-marker';
          tooltipText = 'Nabíjacia stanica';
          break;
        case 'stojan-na-bicykle':
          iconHtml = '<i class="fa-solid fa-bicycle"></i>';
          className += ' bicycle-stand-marker';
          tooltipText = 'Stojan na bicykle';
          break;
        case 'cyklotrasa':
          iconHtml = '<i class="fa-solid fa-route"></i>';
          className += ' cycle-route-marker';
          tooltipText = 'Cyklotrasa';
          break;
        default:
          iconHtml = '<i class="fa-solid fa-map-marker-alt"></i>';
          className += ' default-marker';
          tooltipText = 'Bod záujmu';
      }

      // Použitie div elementu s tooltipom
      return L.divIcon({
        className: className,
        html: `<div class="icon-wrapper">${iconHtml}<span class="icon-tooltip">${tooltipText}</span></div>`,
        iconSize: [32, 32], // Prispôsobte podľa potreby
        iconAnchor: [16, 32], // Stred dole
        popupAnchor: [0, -32] // Nad ikonkou
      });
    }

    // Funkcia na aktualizáciu UI (filtrovanie a zobrazovanie)
    function aktualizujUI() {
      // Skontrolujeme, či sú dáta načítané
      if (allLokalityData.length === 0) {
        console.warn("Dáta ešte nie sú načítané, aktualizácia UI preskočená.");
        return; // Zastavíme, ak dáta nie sú k dispozícii
      }

      const filterValue = document.getElementById('filter').value;
      const searchValue = document.getElementById('searchFilter').value.toLowerCase();
      const lokalityListDiv = document.getElementById('lokality-list');

      // Vyčistíme staré markery a zoznam
      markers.clearLayers();
      lokalityListDiv.innerHTML = '';

      let filteredLokality = allLokalityData.filter(lokalita => {
        const matchesFilter = filterValue === 'all' || lokalita.typ === filterValue;
        const matchesSearch = searchValue === '' ||
          (lokalita.name && lokalita.name.toLowerCase().includes(searchValue)) ||
          (lokalita.adresa && lokalita.adresa.toLowerCase().includes(searchValue)) ||
          (lokalita.polis && lokalita.polis.toLowerCase().includes(searchValue)) || // Mesto/Polis
          (lokalita.popis && lokalita.popis.toLowerCase().includes(searchValue)); // Popis, ak existuje

        return matchesFilter && matchesSearch;
      });

      if (filteredLokality.length === 0) {
        lokalityListDiv.innerHTML = '<p style="text-align: center; color: var(--light-text-color);">Žiadne lokality nevyhovujú filtrom.</p>';
      }

      filteredLokality.forEach(lokalita => {
        // Pridanie markeru na mapu
        const marker = L.marker([lokalita.lat, lokalita.lng], {
          icon: getMarkerIcon(lokalita.typ)
        }).bindPopup(`
          <h3>${lokalita.name || 'Neznámy názov'}</h3>
          <p><strong>Adresa:</strong> ${lokalita.adresa || 'N/A'}</p>
          <p><strong>Mesto:</strong> ${lokalita.polis || 'N/A'}</p>
          <p><strong>Typ:</strong> ${lokalita.typ.replace(/-/g, ' ') || 'N/A'}</p>
          ${lokalita.vykon ? `<p><strong>Výkon:</strong> ${lokalita.vykon} kW</p>` : ''}
          ${lokalita.konektory ? `<p><strong>Konektory:</strong> ${lokalita.konektory}</p>` : ''}
          ${lokalita.popis ? `<p><strong>Popis:</strong> ${lokalita.popis}</p>` : ''}
          ${lokalita.prevadzkovatel ? `<p><strong>Prevádzkovateľ:</strong> ${lokalita.prevadzkovatel}</p>` : ''}
          ${lokalita.id_bodu ? `<p><strong>ID Bodu:</strong> ${lokalita.id_bodu}</p>` : ''}
          ${lokalita.autentifikacia ? `<p><strong>Autentifikácia:</strong> ${lokalita.autentifikacia}</p>` : ''}
          ${lokalita.platba ? `<p><strong>Platba:</strong> ${lokalita.platba}</p>` : ''}
          ${lokalita.kontakt ? `<p><strong>Kontakt:</strong> ${lokalita.kontakt}</p>` : ''}
          ${lokalita.prevadzka ? `<p><strong>Prevádzka:</strong> ${lokalita.prevadzka}</p>` : ''}
          ${lokalita.datum ? `<p><strong>Dátum aktualizácie:</strong> ${lokalita.datum}</p>` : ''}
        `);
        markers.addLayer(marker);

        // Pridanie do zoznamu
        const itemDiv = document.createElement('div');
        itemDiv.className = 'lokalita-item';
        itemDiv.innerHTML = `
          <h3>${lokalita.name || 'Neznámy názov'}</h3>
          <p>${lokalita.adresa || 'N/A'}, ${lokalita.polis || 'N/A'}</p>
          <span class="type-tag">${lokalita.typ.replace(/-/g, ' ')}</span>
        `;
        itemDiv.addEventListener('click', () => {
          mapa.flyTo([lokalita.lat, lokalita.lng], 16); // Priblíži sa k lokalite
          marker.openPopup(); // Otvorí popup
        });
        lokalityListDiv.appendChild(itemDiv);
      });

      mapa.addLayer(markers); // Pridaj klaster markerov na mapu
    }


    // Debounce funkcia pre vyhľadávanie
    let timeoutId;
    function debouncedAktualizujUI() {
      clearTimeout(timeoutId);
      timeoutId = setTimeout(aktualizujUI, 300); // 300ms oneskorenie
    }


    // Inicializácia mapy po načítaní dát
    document.addEventListener('DOMContentLoaded', () => {
      // Inicializácia mapy
      mapa = L.map('mapa').setView([49.00, 21.25], 10); // Stred Prešovského kraja

      // Defaultná podkladová vrstva
      osmLayer.addTo(mapa);
      currentBasemap = osmLayer;

      // Načítanie dát pri štarte
      nacitajLokalityData(); // Toto sa teraz stará o volanie aktualizujUI

      // Prepnúť bočný panel
      const sidebar = document.getElementById('sidebar');
      const sidebarToggle = document.getElementById('sidebar-toggle');

      sidebarToggle.addEventListener('click', () => {
        sidebar.classList.toggle('hidden');
        // Zmeniť ikonu na základe stavu
        const icon = sidebarToggle.querySelector('i');
        if (sidebar.classList.contains('hidden')) {
          icon.classList.remove('fa-bars');
          icon.classList.add('fa-map'); // Alebo iná ikona, napr. fa-arrow-right
        } else {
          icon.classList.remove('fa-map'); // Alebo fa-arrow-left
          icon.classList.add('fa-bars');
        }
        setTimeout(() => mapa.invalidateSize(), 300); // Prekreslí mapu po animácii
      });

      // Zmena podkladovej mapy
      document.getElementById('basemapSelector').addEventListener('change', function() {
        if (currentBasemap) {
          mapa.removeLayer(currentBasemap);
        }
        const selectedBasemap = this.value;
        switch (selectedBasemap) {
          case 'osm':
            currentBasemap = osmLayer.addTo(mapa);
            break;
          case 'google-streets':
            currentBasemap = googleStreets.addTo(mapa);
            break;
          case 'google-satellite':
            currentBasemap = googleSat.addTo(mapa);
            break;
          case 'google-hybrid':
            currentBasemap = googleHybrid.addTo(mapa);
            break;
          default:
            currentBasemap = osmLayer.addTo(mapa);
        }
      });


      // Pridanie poslucháčov pre filtre
      document.getElementById('filter').addEventListener('change', aktualizujUI);
      document.getElementById('searchFilter').addEventListener('input', debouncedAktualizujUI); // Použitie debounced funkcie


      // Welcome Modal Logic
      const hasVisited = sessionStorage.getItem('hasVisitedEcoTransportMap');
      if (!hasVisited) {
        openModal(welcomeModal);
      }

      document.getElementById('closeWelcomeModal').addEventListener('click', () => {
        closeModal(welcomeModal);
        sessionStorage.setItem('hasVisitedEcoTransportMap', 'true');
        mapa.invalidateSize(); // Ensure map displays correctly after modal closes
      });

      document.getElementById('closeWelcomeModal').addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          closeModal(welcomeModal);
          sessionStorage.setItem('hasVisitedEcoTransportMap', 'true');
          mapa.invalidateSize();
        }
      });
    });
  </script>
</body>
</html>